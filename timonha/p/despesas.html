<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Despesas - TIMONHA da Sorte</title>
<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { padding: 20px; background: #f5f5f5; }
h1 { color: green; }
label { display: block; margin: 10px 0 5px; font-weight: bold; }
input[type="text"], input[type="number"], input[type="date"] {
  width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;
}
button {
  background-color: green; color: white; padding: 10px 20px; border: none;
  border-radius: 4px; cursor: pointer; margin-top: 10px;
}
button:hover { background-color: #900000; }
table {
  width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff;
}
th, td {
  border: 1px solid #ccc; padding: 8px; text-align: center;
}
th { background: #ffcccc; }
.acoes button { margin: 0 3px; padding: 5px 10px; font-size: 14px; }
@media (max-width: 600px) {
  button { width: 100%; margin-bottom: 8px; }
  .acoes button { width: 48%; margin-bottom: 5px; }
}
</style>
</head>
<body>

<h1>DESPESAS TIMONHA DA SORTE</h1>

<label for="valorDespesa">Despesa (R$):</label>
<input type="number" id="valorDespesa" min="0" step="0.01" />

<label for="descricaoDespesa">DescriÃ§Ã£o da Despesa:</label>
<input type="text" id="descricaoDespesa" />

<label for="dataDespesa">Data da Despesa:</label>
<input type="date" id="dataDespesa" />

<button id="btnSalvar">Salvar Despesa</button>

<table id="tabelaDespesas">
<thead>
<tr>
<th>Data</th>
<th>DescriÃ§Ã£o</th>
<th>Valor (R$)</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button id="btnExportar" style="margin-top:20px;">Exportar Despesas</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// ðŸ”¹ Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyD91WcNkb6Y4bZIVJdA75m4HlpId7HwbAk",
  authDomain: "pitimbu-da-sorte.firebaseapp.com",
  projectId: "pitimbu-da-sorte",
  storageBucket: "pitimbu-da-sorte.firebasestorage.app",
  messagingSenderId: "689037113918",
  appId: "1:689037113918:web:334207c5b44f37bb992f6f",
  measurementId: "G-3WKL6THK72"
};

// ðŸ”¹ InicializaÃ§Ã£o Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const docRef = doc(db, "movimentos", "timonha_da_sorte");

let despesas = [];
let editarIndex = null;

// ðŸ”¸ Carregar despesas do documento principal
async function carregarDespesas() {
  try {
    const snap = await getDoc(docRef);
    if (snap.exists()) {
      const data = snap.data();
      despesas = data.despesas || [];
    } else {
      despesas = [];
    }
    listarDespesas();
  } catch (e) {
    console.error("Erro ao carregar despesas:", e);
  }
}

// ðŸ”¸ Listar na tabela
function listarDespesas() {
  const tbody = document.querySelector('#tabelaDespesas tbody');
  tbody.innerHTML = '';
  despesas.forEach((d, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.data || ''}</td>
      <td>${d.descricao || ''}</td>
      <td>${Number(d.valor).toFixed(2)}</td>
      <td class="acoes">
        <button onclick="editarDespesa(${i})">Editar</button>
        <button onclick="excluirDespesa(${i})">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// ðŸ”¸ Salvar ou atualizar despesa
async function salvarDespesa() {
  const valor = parseFloat(document.getElementById('valorDespesa').value);
  const descricao = document.getElementById('descricaoDespesa').value.trim();
  const data = document.getElementById('dataDespesa').value;

  if (isNaN(valor) || valor <= 0) return alert('Informe um valor vÃ¡lido.');
  if (!descricao) return alert('Informe a descriÃ§Ã£o.');
  if (!data) return alert('Informe a data.');

  const despesa = { valor, descricao, data };

  if (editarIndex !== null) {
    despesas[editarIndex] = despesa;
    editarIndex = null;
  } else {
    despesas.push(despesa);
  }

  await salvarNoFirestore();
  listarDespesas();
  limparFormulario();
}

// ðŸ”¸ Salvar no mesmo documento de movimentos
async function salvarNoFirestore() {
  try {
    const snap = await getDoc(docRef);
    let data = snap.exists() ? snap.data() : {};
    data.despesas = despesas;
    await setDoc(docRef, data, { merge: true });
  } catch (e) {
    console.error("Erro ao salvar despesas:", e);
  }
}

// ðŸ”¸ Editar despesa
window.editarDespesa = function (i) {
  const d = despesas[i];
  document.getElementById('valorDespesa').value = d.valor;
  document.getElementById('descricaoDespesa').value = d.descricao;
  document.getElementById('dataDespesa').value = d.data;
  editarIndex = i;
}

// ðŸ”¸ Excluir despesa
window.excluirDespesa = async function (i) {
  if (!confirm('Confirma a exclusÃ£o desta despesa?')) return;
  despesas.splice(i, 1);
  await salvarNoFirestore();
  listarDespesas();
}

// ðŸ”¸ Limpar campos
function limparFormulario() {
  document.getElementById('valorDespesa').value = '';
  document.getElementById('descricaoDespesa').value = '';
  document.getElementById('dataDespesa').value = '';
  editarIndex = null;
}

document.getElementById('btnSalvar').addEventListener('click', salvarDespesa);
document.getElementById('btnExportar').addEventListener('click', () => window.print());

window.onload = carregarDespesas;
</script>

</body>
</html>
