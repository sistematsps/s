<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro - Mini WhatsApp</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, updateDoc, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0dUhymi72gkug-oo0-xqqBEtgvlIgvY0",
      authDomain: "cursos-6f950.firebaseapp.com",
      projectId: "cursos-6f950",
      storageBucket: "cursos-6f950.appspot.com",
      messagingSenderId: "146131122545",
      appId: "1:146131122545:web:043f8207f457ad5b7f5ed0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const form = document.getElementById("register-form");
    const vinculosDiv = document.getElementById("vinculosDiv");

    const funcaoSelect = document.getElementById("funcao");
    funcaoSelect.addEventListener("change", () => {
      if (funcaoSelect.value === "cliente") {
        vinculosDiv.style.display = "block";
      } else {
        vinculosDiv.style.display = "none";
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nome = form.nome.value;
      const email = form.email.value;
      const senha = form.senha.value;
      const funcao = form.funcao.value;
      const vendedorSelecionado = form.vendedor?.value || null;

      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, senha);
        const uid = userCred.user.uid;

        // Salvar usuário
        const userRef = doc(db, "users", uid);
        await setDoc(userRef, {
          nome,
          email,
          funcao,
          vinculos: vendedorSelecionado ? [vendedorSelecionado] : []
        });

        // Se for cliente, vincula o vendedor também
        if (funcao === "cliente" && vendedorSelecionado) {
          const vendedorRef = doc(db, "users", vendedorSelecionado);
          await updateDoc(vendedorRef, { vinculos: arrayUnion(uid) });
        }

        alert("Usuário cadastrado com sucesso!");
        form.reset();
      } catch (err) {
        alert("Erro ao cadastrar: " + err.message);
      }
    });

    // Carregar vendedores na lista
    import { getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    async function carregarVendedores() {
      const vendedoresSelect = document.getElementById("vendedor");
      const q = query(collection(db, "users"), where("funcao", "==", "vendedor"));
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap => {
        const user = docSnap.data();
        const opt = document.createElement("option");
        opt.value = docSnap.id;
        opt.textContent = user.nome + " (" + user.email + ")";
        vendedoresSelect.appendChild(opt);
      });
    }
    carregarVendedores();
  </script>

  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    form { background: white; padding: 20px; border-radius: 10px; max-width: 400px; margin: auto; box-shadow: 0 0 5px #aaa; }
    input, select, button { width: 100%; margin: 10px 0; padding: 10px; font-size: 16px; }
    button { background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h2>Cadastro de Usuário</h2>
  <form id="register-form">
    <input type="text" id="nome" name="nome" placeholder="Nome completo" required>
    <input type="email" id="email" name="email" placeholder="E-mail" required>
    <input type="password" id="senha" name="senha" placeholder="Senha" required>
    <select id="funcao" name="funcao" required>
      <option value="">Selecione a função</option>
      <option value="master">Master</option>
      <option value="gerente">Gerente</option>
      <option value="vendedor">Vendedor</option>
      <option value="cliente">Cliente</option>
    </select>

    <div id="vinculosDiv" style="display:none;">
      <label>Selecione o vendedor:</label>
      <select id="vendedor" name="vendedor"></select>
    </div>

    <button type="submit">Cadastrar</button>
  </form>
</body>
</html>
