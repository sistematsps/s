<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caixa Geral</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body { font-family: Arial; background:#f2f2f2; padding:20px }
.box { background:#fff; padding:15px; border-radius:8px; margin-bottom:15px }
input, button { padding:6px; margin:4px }
.cards { display:flex; gap:15px; flex-wrap:wrap }
.card { background:#f9f9f9; border:2px solid #ccc; border-radius:8px; padding:15px; min-width:180px; font-weight:bold }
table { width:100%; border-collapse:collapse }
th, td { border:1px solid #ccc; padding:6px; text-align:center }
th { background:#eee }
</style>
</head>

<body>

<h2>Caixa Geral</h2>

<div class="box">
  <input type="date" id="dataInicial">
  <input type="date" id="dataFinal">
  <button onclick="consultarPeriodo()">Consultar Per√≠odo</button>
</div>

<div class="box cards">
  <div class="card">Apurado<br>R$ <span id="totalApurado">0.00</span></div>
  <div class="card">Despesas<br>R$ <span id="totalDespesas">0.00</span></div>
  <div class="card">Saldo Final<br>R$ <span id="saldoFinal">0.00</span></div>
</div>

<div class="box">
  <h3>Vendas por Vendedor</h3>
  <table>
    <thead>
      <tr>
        <th>Vendedor</th>
        <th>Data</th>
        <th>Bloco</th>
        <th>Vendido</th>
        <th>Apurado</th>
      </tr>
    </thead>
    <tbody id="tabelaVendas"></tbody>
  </table>
</div>

<div class="box">
  <h3>Despesas</h3>
  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Descri√ß√£o</th>
        <th>Valor</th>
      </tr>
    </thead>
    <tbody id="tabelaDespesas"></tbody>
  </table>
</div>

<div class="box">
  <button onclick="gerarPDF()">Gerar PDF</button>
</div>

<script>
/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAdwrOqN4-VQsiBByk4FVG-cDvfrR8ZYac",
  authDomain: "dasorte-66ec5.firebaseapp.com",
  projectId: "dasorte-66ec5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const { jsPDF } = window.jspdf;
let dadosPDF = { vendas: [], despesas: [], totais: {} };

async function consultarPeriodo() {
  const ini = dataInicial.value;
  const fim = dataFinal.value;

  let totalAp = 0;
  let totalDesp = 0;

  tabelaVendas.innerHTML = "";
  tabelaDespesas.innerHTML = "";
  dadosPDF = { vendas: [], despesas: [], totais: {} };

  /* ===== VENDAS ===== */
  const vendedoresSnap = await db.collection("vendedores").get();

  for (const vendDoc of vendedoresSnap.docs) {
    const vendedor = vendDoc.data();
    const nomeVendedor = vendedor.nome || "‚Äî";

    const vendasSnap = await db
      .collection("vendedores")
      .doc(vendDoc.id)
      .collection("vendas")
      .get();

    vendasSnap.forEach(vendaDoc => {
      const v = vendaDoc.data();

      if (!v.data || v.apurado == null || v.vendido == null) return;
      if ((ini && v.data < ini) || (fim && v.data > fim)) return;

      const vendido = Number(v.vendido);
      const apurado = Number(v.apurado);
      const bloco = v.bloco || "-";

      totalAp += apurado;

      tabelaVendas.innerHTML += `
        <tr>
          <td>${nomeVendedor}</td>
          <td>${v.data}</td>
          <td>${bloco}</td>
          <td>${vendido}</td>
          <td>R$ ${apurado.toFixed(2)}</td>
        </tr>
      `;

      dadosPDF.vendas.push([
        nomeVendedor,
        v.data,
        bloco,
        vendido,
        apurado.toFixed(2)
      ]);
    });
  }

  /* ===== DESPESAS ===== */
  const despSnap = await db.collection("despesas").get();
  despSnap.forEach(doc => {
    const d = doc.data();

    if (!d.data || d.valor == null) return;
    if ((ini && d.data < ini) || (fim && d.data > fim)) return;

    const valor = Number(d.valor);
    totalDesp += valor;

    tabelaDespesas.innerHTML += `
      <tr>
        <td>${d.data}</td>
        <td>${d.desc || ""}</td>
        <td>R$ ${valor.toFixed(2)}</td>
      </tr>
    `;

    dadosPDF.despesas.push([
      d.data,
      d.desc || "",
      valor.toFixed(2)
    ]);
  });

  const saldo = totalAp - totalDesp;

  totalApurado.innerText = totalAp.toFixed(2);
  totalDespesas.innerText = totalDesp.toFixed(2);
  saldoFinal.innerText = saldo.toFixed(2);

  dadosPDF.totais = { apurado: totalAp, despesas: totalDesp, saldo };
}

/* ===== PDF ===== */
function gerarPDF() {
  const pdf = new jsPDF();
  pdf.setFontSize(14);
  pdf.text("Relat√≥rio de Caixa Geral", 14, 15);

  pdf.autoTable({
    startY: 22,
    head: [["Vendedor","Data","Bloco","Vendido","Apurado"]],
    body: dadosPDF.vendas
  });

  let y = pdf.lastAutoTable.finalY + 6;

  pdf.autoTable({
    startY: y,
    head: [["Data","Descri√ß√£o","Valor"]],
    body: dadosPDF.despesas
  });

  y = pdf.lastAutoTable.finalY + 8;
  pdf.text(`Apurado: R$ ${dadosPDF.totais.apurado.toFixed(2)}`, 14, y);
  pdf.text(`Despesas: R$ ${dadosPDF.totais.despesas.toFixed(2)}`, 14, y + 6);
  pdf.text(`Saldo: R$ ${dadosPDF.totais.saldo.toFixed(2)}`, 14, y + 12);

  pdf.save("caixa_geral.pdf");
}
</script>

</body>
     </html>
