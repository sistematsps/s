<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Vendedores</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;padding:20px}
.box{background:#fff;padding:15px;border-radius:8px;margin-bottom:20px}
input,button{padding:6px;margin:4px}
.cards{display:flex;flex-wrap:wrap;gap:12px}
.card{width:180px;padding:12px;border-radius:8px;border:2px solid #ccc;cursor:pointer}
.card.ativo{border-color:#007bff;background:#eaf3ff}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#eee}
.totais{margin-top:10px;padding:10px;background:#f9f9f9;border-radius:6px;font-weight:bold;display:flex;gap:15px;flex-wrap:wrap}
</style>
</head>

<body>

<h2>Cadastro de Vendedores</h2>

<div class="box">
  <input id="nomeVendedor" placeholder="Nome do vendedor">
  <input id="cotacao" type="number" placeholder="Cota√ß√£o">
  <br>
  <button onclick="salvarVendedor()">Salvar</button>
  <button onclick="editarCotacao()">Editar Cota√ß√£o</button>
  <button onclick="excluirVendedor()">Excluir</button>
</div>

<div class="box">
  <h3>Vendedores</h3>
  <div class="cards" id="listaVendedores"></div>
</div>

<div class="box" id="vendasBox" style="display:none;">
  <h3>Hist√≥rico ‚Äì <span id="vendedorSelecionado"></span></h3>
  <button onclick="adicionarLinha()">Adicionar Linha</button>

  <table id="tabelaVendas">
    <thead>
      <tr>
        <th>Data</th><th>Bloco</th><th>Anterior</th><th>Final</th>
        <th>Recebido</th><th>Devolvido</th><th>Vendido</th>
        <th>Apurado</th><th>Pago</th><th>Devendo</th><th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="totais">
    <span>Recebido: <span id="tRecebido">0</span></span>
    <span>Vendido: <span id="tVendido">0</span></span>
    <span>Apurado: R$ <span id="tApurado">0</span></span>
    <span>Pago: R$ <span id="tPago">0</span></span>
    <span>Devendo: R$ <span id="tDevendo">0</span></span>
  </div>

  <br>
  <button onclick="salvarVendas()">Salvar Vendas</button>
  <button onclick="gerarPDF()">Gerar PDF</button>
</div>

<script>
const { jsPDF } = window.jspdf;

/* üî• FIREBASE CONFIG ‚Äì CORRETO */
firebase.initializeApp({
  apiKey: "AIzaSyAdwrOqN4-VQsiBByk4FVG-cDvfrR8ZYac",
  authDomain: "dasorte-66ec5.firebaseapp.com",
  projectId: "dasorte-66ec5",
  storageBucket: "dasorte-66ec5.firebasestorage.app",
  messagingSenderId: "606389335961",
  appId: "1:606389335961:web:cf9df8efef813587684508"
});
const db = firebase.firestore();

let vendedorIdAtual = null;
let cotacaoAtual = 0;

/* ===== VENDEDORES ===== */
async function carregarVendedores(){
  listaVendedores.innerHTML="";
  const snap = await db.collection("vendedores").get();
  snap.forEach(doc=>{
    const d = doc.data();
    const card = document.createElement("div");
    card.className = "card" + (doc.id === vendedorIdAtual ? " ativo" : "");
    card.innerHTML = `<strong>${d.nome}</strong><br>Cota√ß√£o: ${d.cotacao}`;
    card.onclick = () => selecionarVendedor(doc.id, d.nome, d.cotacao);
    listaVendedores.appendChild(card);
  });
}

async function salvarVendedor(){
  if(!nomeVendedor.value || !cotacao.value) return alert("Preencha tudo");
  await db.collection("vendedores").add({
    nome: nomeVendedor.value,
    cotacao: Number(cotacao.value)
  });
  nomeVendedor.value = cotacao.value = "";
  carregarVendedores();
}

async function editarCotacao(){
  if(!vendedorIdAtual) return;
  const nova = Number(prompt("Nova cota√ß√£o:"));
  if(isNaN(nova)) return;
  await db.collection("vendedores").doc(vendedorIdAtual).update({ cotacao: nova });
  cotacaoAtual = nova;
  carregarVendedores();
}

async function excluirVendedor(){
  if(!vendedorIdAtual || !confirm("Excluir vendedor?")) return;
  await db.collection("vendedores").doc(vendedorIdAtual).delete();
  vendedorIdAtual = null;
  vendasBox.style.display = "none";
  carregarVendedores();
}

/* ===== VENDAS ===== */
async function selecionarVendedor(id,nome,cot){
  vendedorIdAtual = id;
  cotacaoAtual = cot;
  vendedorSelecionado.innerText = nome;
  vendasBox.style.display = "block";
  carregarVendedores();
  carregarVendas();
}

function adicionarLinha(d=[]){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="date"></td>
    <td><input></td>
    <td><input type="number"></td>
    <td><input type="number"></td>
    <td><input disabled></td>
    <td><input type="number"></td>
    <td><input disabled></td>
    <td><input disabled></td>
    <td><input type="number"></td>
    <td><input disabled></td>
    <td><button onclick="this.closest('tr').remove();calcularTotais()">üóëÔ∏è</button></td>
  `;
  tabelaVendas.querySelector("tbody").appendChild(tr);

  tr.querySelectorAll("input").forEach((i,idx)=>{
    i.value = d[idx] ?? "";
    i.oninput = () => calcularLinha(tr);
  });

  calcularLinha(tr);
}

function calcularLinha(tr){
  const i = tr.querySelectorAll("input");
  const recebido = (+i[3].value||0) - (+i[2].value||0);
  const vendido = recebido - (+i[5].value||0);
  const apurado = vendido * cotacaoAtual;
  const devendo = apurado - (+i[8].value||0);

  i[4].value = recebido;
  i[6].value = vendido;
  i[7].value = apurado.toFixed(2);
  i[9].value = devendo.toFixed(2);

  calcularTotais();
}

function calcularTotais(){
  let r=0,v=0,a=0,p=0,d=0;
  document.querySelectorAll("#tabelaVendas tbody tr").forEach(tr=>{
    const i = tr.querySelectorAll("input");
    r+=+i[4].value||0;
    v+=+i[6].value||0;
    a+=+i[7].value||0;
    p+=+i[8].value||0;
    d+=+i[9].value||0;
  });
  tRecebido.innerText=r;
  tVendido.innerText=v;
  tApurado.innerText=a.toFixed(2);
  tPago.innerText=p.toFixed(2);
  tDevendo.innerText=d.toFixed(2);
}

async function salvarVendas(){
  const ref = db.collection("vendedores").doc(vendedorIdAtual).collection("vendas");
  const old = await ref.get();
  old.forEach(d => d.ref.delete());

  document.querySelectorAll("#tabelaVendas tbody tr").forEach(tr=>{
    const i = tr.querySelectorAll("input");
    ref.add({
      data:i[0].value, bloco:i[1].value,
      anterior:+i[2].value, final:+i[3].value,
      recebido:+i[4].value, devolvido:+i[5].value,
      vendido:+i[6].value, apurado:+i[7].value,
      pago:+i[8].value, devendo:+i[9].value
    });
  });
  alert("Vendas salvas no Firestore");
}

async function carregarVendas(){
  tabelaVendas.querySelector("tbody").innerHTML="";
  const snap = await db.collection("vendedores").doc(vendedorIdAtual).collection("vendas").get();
  snap.forEach(d=>{
    const v = d.data();
    adicionarLinha([
      v.data,v.bloco,v.anterior,v.final,
      v.recebido,v.devolvido,v.vendido,
      v.apurado,v.pago,v.devendo
    ]);
  });
}

/* ===== PDF ===== */
function gerarPDF(){
  const pdf = new jsPDF();
  pdf.text("Relat√≥rio de Vendas",14,15);
  pdf.autoTable({
    startY:25,
    head:[["Data","Bloco","Anterior","Final","Recebido","Devolvido","Vendido","Apurado","Pago","Devendo"]],
    body:[...document.querySelectorAll("#tabelaVendas tbody tr")]
      .map(tr=>[...tr.querySelectorAll("input")].map(i=>i.value))
  });
  pdf.save("relatorio.pdf");
}

carregarVendedores();
</script>

</body>
 </html>
