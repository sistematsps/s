<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
 `<meta name="viewport" content="width=device-width, initial-scale=1.0">` 
<title>Relatório de Vendas</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}

.box {
  background: #fff;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
}

input, select {
  padding: 6px;
  margin: 4px;
}

button {
  padding: 6px 10px;
  margin: 3px;
  cursor: pointer;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}

th {
  background: #eee;
}
</style>
</head>

<body>

<h2>Relatório Geral de Vendas</h2>

<div class="box">
  <select id="filtroVendedor">
    <option value="">Todos os vendedores</option>
  </select>

  <input type="date" id="dataInicial">
  <input type="date" id="dataFinal">

  <br>
  <button onclick="gerarRelatorio()">Gerar Relatório</button>
</div>

<div class="box">
  <table id="tabelaRelatorio">
    <thead>
      <tr>
        <th>Vendedor</th>
        <th>Data</th>
        <th>Anterior</th>
        <th>Final</th>
        <th>Recebido</th>
        <th>Devolvido</th>
        <th>Vendido</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <br>
  <button id="btnPDF" onclick="gerarPDF()" style="display:none;">
    Gerar PDF
  </button>
</div>

<script>
const { jsPDF } = window.jspdf;
let dadosRelatorio = [];

/* ===== CARREGAR VENDEDORES ===== */
function carregarVendedores() {
  const vendedores = JSON.parse(localStorage.getItem("vendedores")) || [];
  const select = document.getElementById("filtroVendedor");

  vendedores.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.nome;
    opt.textContent = v.nome;
    select.appendChild(opt);
  });
}

/* ===== GERAR RELATÓRIO ===== */
function gerarRelatorio() {
  const vendedorFiltro = filtroVendedor.value;
  const dataIni = dataInicial.value;
  const dataFim = dataFinal.value;

  const tbody = document.querySelector("#tabelaRelatorio tbody");
  tbody.innerHTML = "";
  dadosRelatorio = [];

  const vendedores = JSON.parse(localStorage.getItem("vendedores")) || [];

  vendedores.forEach(v => {
    if (vendedorFiltro && v.nome !== vendedorFiltro) return;

    const vendas = JSON.parse(localStorage.getItem("vendas_" + v.nome)) || [];

    vendas.forEach(linha => {
      const data = linha[0];
      if (
        (dataIni && data < dataIni) ||
        (dataFim && data > dataFim)
      ) return;

      const anterior = Number(linha[2]) || 0;
      const final = Number(linha[3]) || 0;
      const devolvido = Number(linha[5]) || 0;

      const recebido = final - anterior;
      const vendido = recebido - devolvido;

      const registro = {
        vendedor: v.nome,
        data,
        anterior,
        final,
        recebido,
        devolvido,
        vendido
      };

      dadosRelatorio.push(registro);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${registro.vendedor}</td>
        <td>${registro.data}</td>
        <td>${registro.anterior}</td>
        <td>${registro.final}</td>
        <td>${registro.recebido}</td>
        <td>${registro.devolvido}</td>
        <td>${registro.vendido}</td>
      `;
      tbody.appendChild(tr);
    });
  });

  btnPDF.style.display = dadosRelatorio.length ? "inline-block" : "none";

  if (!dadosRelatorio.length) {
    alert("Nenhum registro encontrado");
  }
}

/* ===== PDF PROFISSIONAL ===== */
function gerarPDF() {
  const pdf = new jsPDF();
  pdf.setFontSize(14);
  pdf.text("Relatório Geral de Vendas", 14, 15);

  let subtitulo = "Todos os vendedores";
  if (filtroVendedor.value) subtitulo = "Vendedor: " + filtroVendedor.value;

  if (dataInicial.value || dataFinal.value) {
    subtitulo += " | Período: ";
    subtitulo += dataInicial.value || "...";
    subtitulo += " até ";
    subtitulo += dataFinal.value || "...";
  }

  pdf.setFontSize(10);
  pdf.text(subtitulo, 14, 22);

  const body = dadosRelatorio.map(d => [
    d.vendedor,
    d.data,
    d.anterior,
    d.final,
    d.recebido,
    d.devolvido,
    d.vendido
  ]);

  pdf.autoTable({
    startY: 28,
    head: [[
      "Vendedor",
      "Data",
      "Anterior",
      "Final",
      "Recebido",
      "Devolvido",
      "Vendido"
    ]],
    body: body
  });

  pdf.save("relatorio_vendas.pdf");
}

carregarVendedores();
</script>

</body>
</html>

