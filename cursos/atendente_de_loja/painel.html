<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel de Controle - Da Sorte</title>
<style>
  body { font-family: Arial,sans-serif; margin:0; padding:0; background:#f5f5f5; }
  header { background:#b30000; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:24px; }
  nav button { margin:0 5px; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; background:#ff4d4d; color:white; }
  nav button:hover { background:#660000; }
  section { display:none; padding:20px; background:#fff; margin:10px; border-radius:6px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#eee; }
  input { padding:5px; width:90%; }
  .btn-small { padding:5px 10px; margin:3px; cursor:pointer; border:none; border-radius:4px; background:#b30000; color:white; }
  .btn-small:hover { background:#660000; }
</style>
</head>
<body>

<header>
  <h1>Painel Da Sorte</h1>
  <nav id="menu"></nav>
  <button onclick="logout()">Sair</button>
</header>

<!-- Seções do painel -->
<section id="caixa">
  <h2>Caixa</h2>
  <table>
    <tr><th>Saldo Anterior</th><th>Apurado Total</th><th>Despesas</th><th>Saldo Final</th></tr>
    <tr>
      <td id="saldoAnterior">0.00</td>
      <td id="apuradoTotal">0.00</td>
      <td id="despesasTotal">0.00</td>
      <td id="saldoFinal">0.00</td>
    </tr>
  </table>
  <h3>Partilha</h3>
  <div>GERENTE 1 (25%): <span id="partilhaGerente1">0.00</span></div>
  <div>GERENTE 2 (25%): <span id="partilhaGerente2">0.00</span></div>
  <div>BANCA (50%): <span id="partilhaBanca">0.00</span></div>
</section>

<section id="receitas">
  <h2>Receitas</h2>
  <input id="valorReceita" type="number" placeholder="Valor"> 
  <input id="descricaoReceita" placeholder="Descrição"> 
  <input id="dataReceita" type="date"> 
  <button onclick="salvarReceita()">Salvar Receita</button>
  <ul id="listaReceitas"></ul>
</section>

<section id="despesas">
  <h2>Despesas</h2>
  <input type="number" id="valorDespesa" placeholder="Valor">
  <input type="text" id="descricaoDespesa" placeholder="Descrição">
  <input type="date" id="dataDespesa">
  <button onclick="salvarDespesa()">Salvar Despesa</button>
  <ul id="listaDespesas"></ul>
</section>

<section id="gerenciar">
  <h2>Gerenciar</h2>
  <div id="listaGerentes"></div>
</section>

<section id="lancamentos">
  <h2>Lançamentos</h2>
  <div id="listaLancamentos"></div>
</section>

<section id="vendas">
  <h2>Vendas</h2>
  <div id="listaVendedores"></div>
  <div id="painelVendas">
    <h3 id="tituloVendedorSelecionado"></h3>
    <button onclick="voltarListaVendedores()">Voltar</button>
    <button onclick="adicionarLinhaVenda()">Adicionar Linha</button>
    <table id="tabelaVendas">
      <thead>
        <tr><th>Data</th><th>Recebeu</th><th>Devolveu</th><th>Vendeu</th><th>Apurado</th><th>Pagou</th><th>Deve</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:10px;">
      <span>Total Apurado: R$ <span id="totalApurado">0.00</span></span>
      <span>Total Pagou: R$ <span id="totalPagou">0.00</span></span>
      <span>Total Deve: R$ <span id="totalDeve">0.00</span></span>
      <button onclick="salvarVendas()">Salvar Vendas</button>
    </div>
  </div>
</section>

<section id="cadastro">
  <h2>Cadastro</h2>
  <button onclick="window.location.href='cadastro.html'">Ir para Cadastro</button>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAdwrOqN4-VQsiBByk4FVG-cDvfrR8ZYac",
  authDomain: "dasorte-66ec5.firebaseapp.com",
  projectId: "dasorte-66ec5",
  storageBucket: "dasorte-66ec5.firebasestorage.app",
  messagingSenderId: "606389335961",
  appId: "1:606389335961:web:4986562c4ab1b133684508"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let usuarioTipo = localStorage.getItem('tipoUsuario') || 'master';
let usuarioId = localStorage.getItem('uid');

const menu = document.getElementById('menu');

// Cria menu dinamicamente
const itensMenu = [
  {nome:'Caixa', id:'caixa', roles:['master']},
  {nome:'Receitas', id:'receitas', roles:['master']},
  {nome:'Gerenciar', id:'gerenciar', roles:['master']},
  {nome:'Despesas', id:'despesas', roles:['master']},
  {nome:'Lançamentos', id:'lancamentos', roles:['master']},
  {nome:'Vendas', id:'vendas', roles:['master','gerente','vendedor']},
  {nome:'Cadastro', id:'cadastro', roles:['master']}
];

itensMenu.forEach(item=>{
  if(item.roles.includes(usuarioTipo)){
    const btn = document.createElement('button');
    btn.textContent = item.nome;
    btn.onclick = ()=>abrirSecao(item.id);
    menu.appendChild(btn);
  }
});

function abrirSecao(id){
  document.querySelectorAll('section').forEach(sec=>sec.style.display='none');
  document.getElementById(id).style.display='block';
}

// Logout
function logout(){
  signOut(auth).then(()=>{ window.location.href='login.html'; });
}

// ======= CAIXA =======
let receitas=[], despesas=[];
async function carregarCaixa(){
  // Receitas
  const snapReceitas = await getDocs(collection(db,'receitas'));
  receitas = [];
  snapReceitas.forEach(d=>receitas.push(d.data()));
  document.getElementById('listaReceitas').innerHTML = '';
  receitas.forEach(r=>{
    const li = document.createElement('li');
    li.textContent = `${r.data} - ${r.descricao} : R$ ${r.valor.toFixed(2)}`;
    document.getElementById('listaReceitas').appendChild(li);
  });

  // Despesas
  const snapDespesas = await getDocs(collection(db,'despesas'));
  despesas = [];
  snapDespesas.forEach(d=>despesas.push(d.data()));
  document.getElementById('listaDespesas').innerHTML = '';
  despesas.forEach(d=>{
    const li = document.createElement('li');
    li.textContent = `${d.data} - ${d.descricao} : R$ ${d.valor.toFixed(2)}`;
    document.getElementById('listaDespesas').appendChild(li);
  });

  atualizarCaixa();
}

function atualizarCaixa(){
  const saldoAnterior = receitas.reduce((sum,r)=>sum+r.valor,0);
  const apuradoTotal = 0; // pode somar repasses dos gerentes depois
  const despesasTotal = despesas.reduce((sum,d)=>sum+d.valor,0);
  const saldoFinal = saldoAnterior + apuradoTotal - despesasTotal;
  document.getElementById('saldoAnterior').textContent = saldoAnterior.toFixed(2);
  document.getElementById('apuradoTotal').textContent = apuradoTotal.toFixed(2);
  document.getElementById('despesasTotal').textContent = despesasTotal.toFixed(2);
  document.getElementById('saldoFinal').textContent = saldoFinal.toFixed(2);

  document.getElementById('partilhaGerente1').textContent = (saldoFinal*0.25).toFixed(2);
  document.getElementById('partilhaGerente2').textContent = (saldoFinal*0.25).toFixed(2);
  document.getElementById('partilhaBanca').textContent = (saldoFinal*0.5).toFixed(2);
}

// ======= RECEITAS =======
async function salvarReceita(){
  const valor = parseFloat(document.getElementById('valorReceita').value);
  const descricao = document.getElementById('descricaoReceita').value;
  const data = document.getElementById('dataReceita').value;
  if(!valor || !descricao || !data){ alert('Preencha todos os campos'); return; }
  await addDoc(collection(db,'receitas'),{valor,descricao,data});
  document.getElementById('valorReceita').value=''; document.getElementById('descricaoReceita').value=''; document.getElementById('dataReceita').value='';
  carregarCaixa();
}

// ======= DESPESAS =======
async function salvarDespesa(){
  const valor = parseFloat(document.getElementById('valorDespesa').value);
  const descricao = document.getElementById('descricaoDespesa').value;
  const data = document.getElementById('dataDespesa').value;
  if(!valor || !descricao || !data){ alert('Preencha todos os campos'); return; }
  await addDoc(collection(db,'despesas'),{valor,descricao,data});
  document.getElementById('valorDespesa').value=''; document.getElementById('descricaoDespesa').value=''; document.getElementById('dataDespesa').value='';
  carregarCaixa();
}

// ===== Inicialização =====
abrirSecao(itensMenu[0].id);
carregarCaixa();

</script>
</body>
    </html>
