<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Vendas</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
  h1 { text-align: center; }
  .filtros { margin: 20px 0; text-align: center; }
  button { padding: 6px 12px; margin: 5px; cursor: pointer; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #999; padding: 5px; text-align: center; }
  th { background-color: #ccc; }
  hr { margin: 30px 0; }
  #totalDia { font-weight: bold; color: green; margin-top: 20px; }
</style>
</head>
<body>
<h1>PITIMBU DA SORTE</h1>

<div class="filtros">
  <label for="filtroData">Filtrar por data:</label>
  <input type="date" id="filtroData" />
  <button id="btnGerar">Consultar</button>
  <button id="btnExportarDOC">Exportar Word</button>
  <button id="btnPrint">Print da Tela</button>
</div>

<div id="relatorioContainer"></div>
<div id="totalDia"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD8IxOX_0e6T7DUzGf1DlPOHLNCq5zCK2M",
  authDomain: "pitimbu-da-sorte-80aa6.firebaseapp.com",
  projectId: "pitimbu-da-sorte-80aa6",
  storageBucket: "pitimbu-da-sorte-80aa6.firebasestorage.app",
  messagingSenderId: "365898285373",
  appId: "1:365898285373:web:2ce4e344f1e9774c068554"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let relatorioHTML = '';

async function gerarRelatorio() {
  const filtroData = document.getElementById('filtroData').value;
  const relatorioContainer = document.getElementById('relatorioContainer');
  const totalDiaDiv = document.getElementById('totalDia');
  relatorioContainer.innerHTML = '';
  totalDiaDiv.innerHTML = '';
  relatorioHTML = '';

  if (!filtroData) {
    relatorioContainer.innerHTML = '<p style="text-align:center;">Informe uma data para gerar o relatório.</p>';
    return;
  }

  // Documento do dia: YYYYMMDD
  const docId = filtroData.replace(/-/g,'');
  const docRef = doc(db, 'cotacoes', docId);
  const docSnap = await getDoc(docRef);

  if (!docSnap.exists()) {
    relatorioContainer.innerHTML = '<p style="text-align:center;">Nenhuma cotação encontrada para esta data.</p>';
    return;
  }

  const cotacoes = docSnap.data();
  const vendedores = cotacoes.vendedores || {};
  if (Object.keys(vendedores).length === 0) {
    relatorioContainer.innerHTML = '<p style="text-align:center;">Nenhum vendedor cadastrado nesta data.</p>';
    return;
  }

  let algumResultado = false;
  let totalApuradoDia = 0;
  const detalhesVendedores = [];

  for (const key in vendedores) {
    const v = vendedores[key];
    const cotacao = v.cotacao || 0;
    const nome = v.nome || key;

    // Exemplo: simular vendas com base na cotação
    const recebeu = 100; // aqui você pode ajustar para buscar valores reais
    const devolveu = 0;
    const vendeu = recebeu - devolveu;
    const apurou = vendeu * cotacao;
    const pagou = 0;
    const deve = apurou - pagou;

    algumResultado = true;
    totalApuradoDia += apurou;
    detalhesVendedores.push({ nome, valor: apurou });

    let html = `<h3>${nome.toUpperCase()}</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Recebeu</th>
                      <th>Devolveu</th>
                      <th>Vendeu</th>
                      <th>Apurou</th>
                      <th>Pagou</th>
                      <th>Deve</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>${filtroData}</td>
                      <td>${recebeu}</td>
                      <td>${devolveu}</td>
                      <td>${vendeu}</td>
                      <td>R$ ${apurou.toFixed(2)}</td>
                      <td>R$ ${pagou.toFixed(2)}</td>
                      <td>R$ ${deve.toFixed(2)}</td>
                    </tr>
                  </tbody>
                </table><hr>`;

    relatorioContainer.innerHTML += html;
    relatorioHTML += html;
  }

  if (!algumResultado) {
    relatorioContainer.innerHTML = '<p style="text-align:center;">Nenhuma venda encontrada para esta data.</p>';
    return;
  }

  let htmlResumo = `<p>Total apurado em <strong>${filtroData}</strong>: R$ ${totalApuradoDia.toFixed(2)}</p>`;
  htmlResumo += '<ul>';
  detalhesVendedores.forEach(v => htmlResumo += `<li>${v.nome}: R$ ${v.valor.toFixed(2)}</li>`);
  htmlResumo += '</ul>';
  totalDiaDiv.innerHTML = htmlResumo;
  relatorioHTML += htmlResumo;
}

// Botões
document.getElementById('btnGerar').addEventListener('click', gerarRelatorio);
document.getElementById('btnExportarDOC').addEventListener('click', () => {
  if (!relatorioHTML) { alert('Gere o relatório primeiro'); return; }
  const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                 "xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>" +
                 "<head><meta charset='utf-8'><title>Relatório de Vendas</title></head><body>";
  const footer = "</body></html>";
  const blob = new Blob([header + relatorioHTML + footer], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'relatorio_vendas.doc';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
});
document.getElementById('btnPrint').addEventListener('click', () => window.print());

// Carregar relatório do dia atual automaticamente
window.onload = () => {
  const hoje = new Date().toISOString().split('T')[0];
  document.getElementById('filtroData').value = hoje;
  gerarRelatorio();
};
</script>
</body>
</html>
