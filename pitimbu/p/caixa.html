<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Caixa - Pitimbu da Sorte</title>
<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { padding: 20px; background: #f5f5f5; }
h1, h2 { color: red; }
input, button, select { padding: 8px; margin: 5px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #ffcccc; }
.total-box { margin: 20px 0; padding: 15px; background: #fff3f3; border: 1px solid #b30000; }
.totais span { display: inline-block; min-width: 150px; margin-right: 20px; font-weight: bold; }
hr { margin: 30px 0; border: 1px solid #b30000; }
button { cursor:pointer; background:red; color:white; border:none; border-radius:5px; }
button:hover { background:blue; }
</style>
</head>
<body>

<h1>PITIMBU DA SORTE - CAIXA</h1>

<div class="total-box totais">
  <span>APURADO DO DIA: R$ <span id="apuradoTotal">0.00</span></span>
  <span>DESPESAS: R$ <span id="despesasTotal">0.00</span></span>
  <span>SALDO FINAL: R$ <span id="saldoFinal">0.00</span></span>
</div>

<hr>

<label>De: <input type="date" id="dataInicio"></label>
<label>Até: <input type="date" id="dataFim"></label>
<button id="btnFiltrar">Filtrar</button>

<h2>Resumo de Vendas</h2>
<table id="tabelaResumo">
<thead>
<tr>
<th>Data</th>
<th>Vendedor</th>
<th>Vendeu</th>
<th>Apurou</th>
<th>Pagou</th>
<th>Deve</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2>Despesas</h2>
<table id="tabelaDespesas">
<thead>
<tr>
<th>Data</th>
<th>Descrição</th>
<th>Valor</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2>Partilha de Recursos</h2>
<div class="total-box">
<p>BENEDITO JUNIOR: R$ <span id="benedito">0.00</span></p>
<p>JOSE ROBERTO: R$ <span id="jose">0.00</span></p>
<p>PEDRO CARVALHO: R$ <span id="pedro">0.00</span></p>
</div>

<button id="btnExportar">Exportar em PDF</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD8IxOX_0e6T7DUzGf1DlPOHLNCq5zCK2M",
  authDomain: "pitimbu-da-sorte-80aa6.firebaseapp.com",
  projectId: "pitimbu-da-sorte-80aa6",
  storageBucket: "pitimbu-da-sorte-80aa6.firebasestorage.app",
  messagingSenderId: "365898285373",
  appId: "1:365898285373:web:2ce4e344f1e9774c068554"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ** CORREÇÃO PRINCIPAL **
// Buscar o documento correto: /cotacoes (coleção) -> documento "dados"
const docRef = doc(db, "cotacoes", "dados");

function formatar(v){ return parseFloat(v || 0).toFixed(2); }

async function carregarCaixa(inicio='', fim='') {
  try {
    const snap = await getDoc(docRef);
    if(!snap.exists()){
      console.error("Documento /cotacoes/dados não existe.");
      alert("Nenhum dado encontrado em /cotacoes/dados");
      return;
    }

    // Se os seus dados estiverem aninhados dentro de um campo 'dados' (como você mostrou),
    // use root = data.dados, caso contrário use o próprio data.
    const raw = snap.data();
    const root = raw.dados && typeof raw.dados === 'object' ? raw.dados : raw;

    console.log("Documento lido com sucesso. root keys:", Object.keys(root));

    const vendasMap = root.vendas || {};
    const despesasMap = root.despesas || {};
    const hoje = new Date().toISOString().split("T")[0];

    const tbodyResumo = document.querySelector("#tabelaResumo tbody");
    const tbodyDespesas = document.querySelector("#tabelaDespesas tbody");
    tbodyResumo.innerHTML = "";
    tbodyDespesas.innerHTML = "";

    let totalApurado = 0;
    let totalDespesas = 0;

    // VENDAS
    for (const vendedor of Object.keys(vendasMap)) {
      const mapaVendas = vendasMap[vendedor] || {};
      for (const chave of Object.keys(mapaVendas)) {
        const v = mapaVendas[chave];
        const dataVenda = v?.data || '';
        // aplicando filtros
        if (inicio && fim) {
          if (dataVenda < inicio || dataVenda > fim) continue;
        } else {
          if (dataVenda !== hoje) continue;
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dataVenda}</td>
          <td>${vendedor}</td>
          <td>${formatar(v.vendeu)}</td>
          <td>${formatar(v.apurou)}</td>
          <td>${formatar(v.pagou)}</td>
          <td>${formatar(v.deve)}</td>
        `;
        tbodyResumo.appendChild(tr);
        totalApurado += parseFloat(v.apurou || 0);
      }
    }

    // DESPESAS
    for (const chave of Object.keys(despesasMap)) {
      const d = despesasMap[chave];
      const dataDesp = d?.data || '';
      if (inicio && fim) {
        if (dataDesp < inicio || dataDesp > fim) continue;
      } else {
        if (dataDesp !== hoje) continue;
      }
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${dataDesp}</td><td>${d.descricao||''}</td><td>${formatar(d.valor)}</td>`;
      tbodyDespesas.appendChild(tr);
      totalDespesas += parseFloat(d.valor || 0);
    }

    const totalFinal = totalApurado - totalDespesas;
    document.getElementById("apuradoTotal").textContent = formatar(totalApurado);
    document.getElementById("despesasTotal").textContent = formatar(totalDespesas);
    document.getElementById("saldoFinal").textContent = formatar(totalFinal);

    document.getElementById("benedito").textContent = formatar(totalFinal * 0.25);
    document.getElementById("jose").textContent = formatar(totalFinal * 0.25);
    document.getElementById("pedro").textContent = formatar(totalFinal * 0.5);

  } catch (err) {
    console.error("Erro ao carregar caixa:", err);
    alert("Erro ao carregar dados. Veja o console (F12).");
  }
}

// FILTRO
document.getElementById("btnFiltrar").addEventListener("click", ()=>{
  const inicio = document.getElementById("dataInicio").value;
  const fim = document.getElementById("dataFim").value;
  if (inicio && !fim) { alert("Informe a data final do filtro."); return; }
  if (fim && !inicio) { alert("Informe a data inicial do filtro."); return; }
  carregarCaixa(inicio || '', fim || '');
});

// EXPORTAR
document.getElementById("btnExportar").addEventListener("click", ()=>window.print());

// CARREGAR INICIAL
window.onload = ()=>carregarCaixa();
</script>

</body>
  </html>
