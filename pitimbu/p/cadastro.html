<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PITIMBU DA SORTE - Master</title>
<style>
/* (mantido igual ao seu código original) */
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { padding: 20px; background: #f5f5f5; }
h1, h2 { color: red; }
input, button, select { padding: 8px; margin: 5px; }
button { background: red; color: white; border: none; cursor: pointer; border-radius: 4px; width: 30%; }
button:hover { background: blue; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: white; }
.vendor-row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
.vendor-btn { flex:1; text-align:left; background: yellow; color:#333; border:1px solid #d0d0d0; padding:12px 14px; font-size:16px; border-radius:6px; cursor:pointer; }
.vendor-btn:hover { background:#f3f3f3; }
.vendor-meta { font-size:16px; color:#666; margin-left:8px; }
.vendor-del { background:black; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
.vendor-del:hover { background:#990000; }
#painelVendedor { margin-top:20px; background:yellow; padding:15px; border:1px solid #b30000; border-radius:6px; display:none; }
.totais span { margin-right:20px; font-weight:bold; }
.small { font-size:12px; color:#333; }
.controls { display:flex; gap:8px; align-items:center; }
</style>
</head>
<body>

<h1>PITIMBU DA SORTE - PAINEL MASTER</h1>
<div class="small">Documento Firestore: <strong>cotacoes/dados_gerais</strong> — Última atualização: <span id="lastUpdated">—</span></div>

<!-- Controles principais -->
<div style="margin-top:10px;">
  <input id="nome" placeholder="Nome do vendedor"/>
  <input id="cotacao" placeholder="Cotação" type="number" step="0.01" min="0"/>
  <button onclick="salvarVendedor()">Salvar</button>
  <button onclick="editarVendedor()">Editar</button>
  <button onclick="forcarCarregar()">Recarregar</button>
</div>

<div id="listaVendedores" style="margin-top:12px;"></div>

<!-- Painel de vendas -->
<div id="painelVendedor">
  <h2 id="tituloVendedor"></h2>
  <button onclick="voltarCadastro()">Voltar ao cadastro</button>

  <div style="margin-top:15px;" class="controls">
    <label>Filtrar por data: <input type="date" id="filtroData"/></label>
    <button onclick="filtrarPorData()">Filtrar</button>
    <button onclick="limparFiltro()">Limpar filtro</button>
    <button onclick="exportarPDF()">Exportar em PDF</button>
    <button id="btnSalvarVendas" onclick="salvarVendas()" style="margin-left:10px;">Salvar Vendas</button>
  </div>

  <button style="margin-top:15px;" onclick="adicionarLinha()">Adicionar venda</button>

  <table id="tabelaVendas">
    <thead>
      <tr>
        <th>Data</th>
        <th>Recebeu</th>
        <th>Devolveu</th>
        <th>Vendeu</th>
        <th>Apurou</th>
        <th>Pagou</th>
        <th>Deve</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="totais" style="margin-top:10px;">
    <span>Total Apurado: R$ <span id="totalApurado">0.00</span></span>
    <span>Total Despesas: R$ <span id="totalDespesas">0.00</span></span>
    <span>Total Final: R$ <span id="totalFinal">0.00</span></span>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD8IxOX_0e6T7DUzGf1DlPOHLNCq5zCK2M",
  authDomain: "pitimbu-da-sorte-80aa6.firebaseapp.com",
  projectId: "pitimbu-da-sorte-80aa6",
  storageBucket: "pitimbu-da-sorte-80aa6.firebasestorage.app",
  messagingSenderId: "365898285373",
  appId: "1:365898285373:web:2ce4e344f1e9774c068554"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// documento único
const docRef = doc(db, "cotacoes", "dados_gerais");

let vendedoresArray = [];
let vendasMap = {};
let despesasMap = {};
let currentVendor = null;

// Função auxiliar
function nomeToKey(nome){ return nome.replace(/\./g,'_').replace(/\//g,'_'); }
function moeda(n){ return Number(n||0).toFixed(2); }

async function carregarTudoFirestore(){
  const snap = await getDoc(docRef);
  if(snap.exists()){
    const data = snap.data();
    vendedoresArray = [];
    vendasMap = data.vendas || {};
    despesasMap = data.despesas || {};
    if(data.vendedores){
      for(const k in data.vendedores){
        const v = data.vendedores[k];
        vendedoresArray.push({ nome:v.nome, cotacao:v.cotacao, _key:k });
      }
    }
    document.getElementById("lastUpdated").textContent = data.lastUpdated?.toDate?.().toLocaleString() || "—";
  }
  listarVendedores();
}

async function salvarTudoFirestore(){
  const vendedoresObj = {};
  vendedoresArray.forEach(v=> vendedoresObj[v._key] = { nome:v.nome, cotacao:v.cotacao });

  const payload = {
    vendedores: vendedoresObj,
    vendas: vendasMap,
    despesas: despesasMap,
    lastUpdated: serverTimestamp()
  };
  await setDoc(docRef, payload, { merge:true });
  await carregarTudoFirestore();
}

function listarVendedores(){
  const div = document.getElementById('listaVendedores'); div.innerHTML='';
  vendedoresArray.forEach(v=>{
    const row=document.createElement('div'); row.className='vendor-row';
    const btn=document.createElement('button'); btn.className='vendor-btn';
    btn.textContent = `${v.nome} (Cotação: R$${v.cotacao})`;
    btn.onclick=()=>abrirPainel(v);
    row.appendChild(btn);
    div.appendChild(row);
  });
}

function abrirPainel(v){
  currentVendor=v;
  document.getElementById('painelVendedor').style.display='block';
  document.getElementById('tituloVendedor').textContent=v.nome;
  atualizarTabela();
}

function voltarCadastro(){
  document.getElementById('painelVendedor').style.display='none';
}

function adicionarLinha(){
  const tbody=document.querySelector('#tabelaVendas tbody');
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input type="date"/></td>
  <td><input type="number" min="0"/></td>
  <td><input type="number" min="0"/></td>
  <td><input type="number" readonly/></td>
  <td><input type="number" readonly/></td>
  <td><input type="number" min="0"/></td>
  <td><input type="number" readonly/></td>
  <td><button onclick="this.parentElement.parentElement.remove()">Excluir</button></td>`;
  tbody.appendChild(tr);
}

function atualizarTabela(){
  const tbody=document.querySelector('#tabelaVendas tbody'); tbody.innerHTML='';
  const arr=vendasMap[currentVendor._key]||[];
  for(const id in arr){
    const v=arr[id];
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="date" value="${v.data||''}"/></td>
    <td><input type="number" value="${v.recebeu||0}"/></td>
    <td><input type="number" value="${v.devolveu||0}"/></td>
    <td><input type="number" value="${v.vendeu||0}" readonly/></td>
    <td><input type="number" value="${v.apurou||0}" readonly/></td>
    <td><input type="number" value="${v.pagou||0}"/></td>
    <td><input type="number" value="${v.deve||0}" readonly/></td>
    <td><button onclick="this.parentElement.parentElement.remove()">Excluir</button></td>`;
    tbody.appendChild(tr);
  }
  atualizarTotais();
}

function atualizarTotais(){
  let apurado=0;
  for(const vend in vendasMap){
    for(const id in vendasMap[vend]){
      apurado += Number(vendasMap[vend][id].apurou)||0;
    }
  }
  let despesas=0;
  for(const d in despesasMap){
    despesas += Number(despesasMap[d].valor)||0;
  }
  const final = apurado - despesas;
  document.getElementById('totalApurado').textContent = moeda(apurado);
  document.getElementById('totalDespesas').textContent = moeda(despesas);
  document.getElementById('totalFinal').textContent = moeda(final);
}

window.salvarTudoFirestore = salvarTudoFirestore;
window.voltarCadastro = voltarCadastro;
window.adicionarLinha = adicionarLinha;

await carregarTudoFirestore();
</script>

</body>
  </html>
